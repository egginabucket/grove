//~ Revision: 116, Copyright (C) 2016-2018: Willem Vree, contributions St√©phane David.
//~ This program is free software; you can redistribute it and/or modify it under the terms of the
//~ GNU General Public License as published by the Free Software Foundation; either version 2 of
//~ the License, or (at your option) any later version.
//~ This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
//~ without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
//~ See the GNU General Public License for more details. <http://www.gnu.org/licenses/gpl.html>.
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,n){a!=Array.prototype&&a!=Object.prototype&&(a[b]=n.value)};$jscomp.getGlobal=function(a){a=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var b=0;b<a.length;++b){var n=a[b];if(n&&n.Math==Math)return n}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(a,b){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function a(n){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(n||"")+"_"+b++,n)}var b=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var n=0,k={next:function(){if(n<a.length){var d=n++;return{value:b(d,a[d]),done:!1}}k.next=function(){return{done:!0,value:void 0}};return k.next()}};k[Symbol.iterator]=function(){return k};return k};
$jscomp.polyfill=function(a,b,n,k){if(b){n=$jscomp.global;a=a.split(".");for(k=0;k<a.length-1;k++){var d=a[k];d in n||(n[d]={});n=n[d]}a=a[a.length-1];k=n[a];b=b(k);b!=k&&null!=b&&$jscomp.defineProperty(n,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");$jscomp.polyfill("Math.log10",function(a){return a?a:function(a){return Math.log(a)/Math.LN10}},"es6","es3");
$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(a){function b(){this.batch_=null}function n(a){return a instanceof d?a:new d(function(r,b){r(a)})}if(a&&!$jscomp.FORCE_POLYFILL_PROMISE)return a;b.prototype.asyncExecute=function(a){if(null==this.batch_){this.batch_=[];var r=this;this.asyncExecuteFunction(function(){r.executeBatch_()})}this.batch_.push(a)};var k=$jscomp.global.setTimeout;b.prototype.asyncExecuteFunction=function(a){k(a,0)};b.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var a=
this.batch_;this.batch_=[];for(var z=0;z<a.length;++z){var b=a[z];a[z]=null;try{b()}catch(M){this.asyncThrow_(M)}}}this.batch_=null};b.prototype.asyncThrow_=function(a){this.asyncExecuteFunction(function(){throw a;})};var d=function(a){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var r=this.createResolveAndReject_();try{a(r.resolve,r.reject)}catch(A){r.reject(A)}};d.prototype.createResolveAndReject_=function(){function a(a){return function(r){d||(d=!0,a.call(b,r))}}var b=this,d=!1;
return{resolve:a(this.resolveTo_),reject:a(this.reject_)}};d.prototype.resolveTo_=function(a){if(a===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(a instanceof d)this.settleSameAsPromise_(a);else{a:switch(typeof a){case "object":var r=null!=a;break a;case "function":r=!0;break a;default:r=!1}r?this.resolveToNonPromiseObj_(a):this.fulfill_(a)}};d.prototype.resolveToNonPromiseObj_=function(a){var r=void 0;try{r=a.then}catch(A){this.reject_(A);return}"function"==typeof r?
this.settleSameAsThenable_(r,a):this.fulfill_(a)};d.prototype.reject_=function(a){this.settle_(2,a)};d.prototype.fulfill_=function(a){this.settle_(1,a)};d.prototype.settle_=function(a,b){if(0!=this.state_)throw Error("Cannot settle("+a+", "+b+"): Promise already settled in state"+this.state_);this.state_=a;this.result_=b;this.executeOnSettledCallbacks_()};d.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var a=0;a<this.onSettledCallbacks_.length;++a)N.asyncExecute(this.onSettledCallbacks_[a]);
this.onSettledCallbacks_=null}};var N=new b;d.prototype.settleSameAsPromise_=function(a){var b=this.createResolveAndReject_();a.callWhenSettled_(b.resolve,b.reject)};d.prototype.settleSameAsThenable_=function(a,b){var d=this.createResolveAndReject_();try{a.call(b,d.resolve,d.reject)}catch(M){d.reject(M)}};d.prototype.then=function(a,b){function r(a,b){return"function"==typeof a?function(b){try{n(a(b))}catch(Y){k(Y)}}:b}var n,k,z=new d(function(a,b){n=a;k=b});this.callWhenSettled_(r(a,n),r(b,k));return z};
d.prototype.catch=function(a){return this.then(void 0,a)};d.prototype.callWhenSettled_=function(a,b){function d(){switch(n.state_){case 1:a(n.result_);break;case 2:b(n.result_);break;default:throw Error("Unexpected state: "+n.state_);}}var n=this;null==this.onSettledCallbacks_?N.asyncExecute(d):this.onSettledCallbacks_.push(d)};d.resolve=n;d.reject=function(a){return new d(function(b,d){d(a)})};d.race=function(a){return new d(function(b,d){for(var r=$jscomp.makeIterator(a),k=r.next();!k.done;k=r.next())n(k.value).callWhenSettled_(b,
d)})};d.all=function(a){var b=$jscomp.makeIterator(a),r=b.next();return r.done?n([]):new d(function(a,d){function k(b){return function(d){z[b]=d;A--;0==A&&a(z)}}var z=[],A=0;do z.push(void 0),A++,n(r.value).callWhenSettled_(k(z.length-1),d),r=b.next();while(!r.done)})};return d},"es6","es3");var xmlplay_VERSION=116;
(function(){function a(a){console.log(a);x.innerHTML+=a+"<br>"}function b(a){console.log(a);x.innerHTML+='<div style="white-space: nowrap">'+a+"</div>"}function n(a,b,g){function f(a){var c,l,f,h,e,b={},g={},C=[18,20,22,24,26,28];a=a.split("\n");for(c=0;c<a.length;++c){var d=a[c];if(0<=d.indexOf("strings")&&(l=d.match(/V:\s*(\S+).*strings\s*=\s*(\S+)/))){var q=l[1];b[q]={};l[2].split(",").forEach(function(a,c){f=a[0];h=12*parseInt(a[1]);e=h+[0,2,4,5,7,9,11]["CDEFGAB".indexOf(f)]+12;b[q][C[c]]=e});
g[q]=0<=d.indexOf("diafret")}}return[b,g]}function q(a){var c,l,f={};a=a.split("\n");for(c=0;c<a.length;++c){var h=a[c];if(0<=h.indexOf("%%map")&&(l=h.match(/%%map *(\S+) *(\S+).*midi=(\d+)/))){h=l[1];var e=l[2];l=l[3];f[h+e]=parseInt(l)}}return f}function c(a){var c={diamond:1,triangle:1,square:1,normal:1},l=h,f,e="default",b={"default":[]},g={"default":[]};a=a.split("\n");for(f=0;f<a.length;++f){var d=a[f];if(0<=d.indexOf("I:percmap")){d=d.split(" ").map(function(a){return a.trim()});var q=d[4];
q in c&&(q=q+"+,"+q);d="%%map perc"+e+" "+d[1]+" print="+d[2]+" midi="+d[3]+" heads="+q;b[e].push(d)}0<=d.indexOf("%%MIDI")&&g[e].push(d);0<=d.indexOf("V:")&&(q=d.match(/V:\s*(\S+)/))&&(e=q[1],e in b||(b[e]=[],g[e]=[]))}c=Object.keys(b).sort();for(f=0;f<c.length;++f)l=l.concat(b[c[f]]);e="default";for(f=0;f<a.length;++f)d=a[f],0<=d.indexOf("I:percmap")||0<=d.indexOf("%%MIDI")||(0<=d.indexOf("V:")||0<=d.indexOf("K:")?((q=d.match(/V:\s*(\S+)/))&&(e=q[1]),l.push(d),e in g&&g[e].length&&(l=l.concat(g[e]),
delete g[e]),0<=d.indexOf("perc")&&-1==d.indexOf("map=")&&(d+=" map=perc"),0<=d.indexOf("map=perc")&&0<b[e].length&&l.push("%%voicemap perc"+e),0<=d.indexOf("map=off")&&l.push("%%voicemap")):l.push(d));return l.join("\n")}var h='%%beginsvg\n<defs>,<text id="x" x="-3" y="0">&#xe263;</text>,<text id="x-" x="-3" y="0">&#xe263;</text>,<text id="x+" x="-3" y="0">&#xe263;</text>,<text id="normal" x="-3.7" y="0">&#xe0a3;</text>,<text id="normal-" x="-3.7" y="0">&#xe0a3;</text>,<text id="normal+" x="-3.7" y="0">&#xe0a4;</text>,<g id="circle-x"><text x="-3" y="0">&#xe263;</text><circle r="4" class="stroke"></circle></g>,<g id="circle-x-"><text x="-3" y="0">&#xe263;</text><circle r="4" class="stroke"></circle></g>,<path id="triangle" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="stroke-width:1.4"></path>,<path id="triangle-" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="stroke-width:1.4"></path>,<path id="triangle+" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="fill:#000"></path>,<path id="square" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="stroke-width:1.4"></path>,<path id="square-" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="stroke-width:1.4"></path>,<path id="square+" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="fill:#000"></path>,<path id="diamond" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="stroke-width:1.4"></path>,<path id="diamond-" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="stroke-width:1.4"></path>,<path id="diamond+" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="fill:#000"></path>,</defs>\n%%endsvg'.split(",");
g&&(0<=a.indexOf("I:percmap")&&(a=c(a)),0<=a.indexOf("%%map")&&(sa=q(a)),0<=a.indexOf(" strings")&&f(a));G=b;Z=0;var e=function(){d(a,b,g)};g?k(a,e):e()}function k(a,d){function f(a){var c=[];a.forEach(function(a,f){c[a.st]?c[a.st].push(f):c[a.st]=[f];a.clef.clef_octave&&(Q[f]=a.clef.clef_octave);H[f]=a.midictl&&a.midictl[7];void 0==H[f]&&(H[f]=100);I[f]=a.midictl&&a.midictl[10];void 0==I[f]&&(I[f]=64);h[f]=a.instr?a.instr:0});return c}var b="",q=[3,0,4,1,5,2,6],c=[0,2,4,5,7,9,11];K=[];Q=[];R=120;
H=[];I=[];var h=[];var e=new Abc({img_out:null,errmsg:function(a,c,f){b+=a+"\n"},read_file:function(a){return""},anno_start:null,get_abcmodel:function(e,b,g){function l(a,c){D[a]=[0,0,0,0,0,0,0];P[a]={};F[a]=c;var f=0<=c;(f?q.slice(0,c):q.slice(c)).forEach(function(c){D[a][c]+=f?1:-1})}var D={},C={"-2":-2,"-1":-1,0:0,1:1,2:2,3:0},P={},F={},E={},n={ppp:30,pp:45,p:60,mp:75,mf:90,f:105,ff:120,fff:127},r=[];g=b[0].meter.a_meter;g.length&&parseInt(g[0].top);for(t=0;t<b.length;++t)l(t,b[t].key.k_sf),E[t]=
{};g={};ta=b.length;aa=f(b);for(var m=e;m;m=m.ts_next){var y=[],t;switch(m.type){case 14:e=m.tempo_notes.reduce(function(a,c){return a+c});R=m.tempo*e/384;break;case 10:var k={t:m.time,mnum:-1,dur:m.dur};y.push(k);K.push({t:m.time,ix:m.istart,v:m.v,ns:y,inv:m.invis,tmp:R});break;case 8:var v=h[m.v];"p"==m.p_v.clef.clef_type&&(v+=128);for(e=0;e<m.notes.length;++e){b=m.notes[e];var B=b.pit+19;t=m.v;m.a_dd&&m.a_dd.forEach(function(a){(w=n[a.name])&&aa[m.st].forEach(function(a){r[a]=w});"swing"==a.name&&
(a=m.dur/3,m.dur+=a,m.next.time+=a,m.next.dur-=a)});var w=r[t]||60;Q[t]&&(B+=Q[t]);k=Math.floor(B/7);var x=B%7;void 0!=b.acc&&(P[t][B]=C[b.acc]);k=12*k+c[x]+(B in P[t]?P[t][B]:D[t][x]);x=m.p_v.map;b.midi&&(k=b.midi);if(128<=v&&"MIDIdrum"!=x){var u=a.substring(m.istart,m.iend);u=u.match(/[=_^]*[A-Ga-g]/)[0];(x=sa[x+u])&&(k=x)}k=128*v+k;g[k]=1;k={t:m.time,mnum:k,dur:m.dur,velo:w};B in E[t]?(E[t][B].dur+=m.dur,b.tie_ty||delete E[t][B],k.mnum=-1):b.tie_ty&&(E[t][B]=k);y.push(k)}if(0==y.length)break;K.push({t:m.time,
ix:m.istart,v:m.v,ns:y,stf:m.st,tmp:R});break;case 5:l(m.v,m.k_sf);break;case 0:l(m.v,F[m.v]);K.push({t:m.time,ix:m.istart,v:m.v,bt:m.bar_type,tx:m.text});break;case 16:m.instr&&(h[m.v]=m.instr),7==m.ctrl&&(H[m.v]=m.val),10==m.ctrl&&(I[m.v]=m.val)}}ba.forEach(function(a){var c=a.parentNode;c&&c.removeChild(a)});S=[];C="#f9f #3cf #c99 #f66 #fc0 #cc0 #ccc".split(" ");for(e=0;e<ta;++e)E=1<<e&0?"0":"",t=document.createElementNS("http://www.w3.org/2000/svg","rect"),t.setAttribute("fill",C[e%C.length]+
E),t.setAttribute("fill-opacity","0.5"),t.setAttribute("width","0"),ba.push(t),S.push(-1);d();ca=Object.keys(g);null!=p?qa():alert("Your browser has no Web Audio API -> no playback.")}});e.tosvg("play","%%play");e.tosvg("abc2svg",a);""==b&&(b="no error");console.log(b.trim())}function d(a,b,d){function f(c){c.stopPropagation();var f=L.indexOf(this);if(!d||0>f)J(0),n(a,b,1);else{var e=c.clientX;e-=this.getBoundingClientRect().left;var l=e*da;if(l<F||l>k)J(0);else{ea||J(1);var h=(c.clientY-this.getBoundingClientRect().top)*
da;e=fa[f];for(c=0;c<e.length;c++)if(e[c]>h){ha=c;break}for(c=0;c<w.length;++c)if(h=w[c].xy)if(e=w[c].vce,-1!=aa[ha].indexOf(e)){var g=h[0];e=h[1];h=h[3];if(!(g<f)&&l<parseFloat(e)+h){u=c;for(l=w[c].t;w[c]&&w[c].t==l;)r(w[c]),c+=1;break}}}}}var g="",c="",h=0;u=0;ia={};fa=[];var e={},l,q,F=1E3,k=0;ha=0;if(a){var p=new Abc({imagesize:'width="100%"',img_out:function(a){-1!=a.indexOf("<svg")&&(fa[h]=Object.keys(e),e={},h+=1,l<F&&(F=l),q>k&&(k=q));g+=a},errmsg:function(a,f,e){c+=a+"\n"},read_file:function(a){return""},
anno_start:function(a,c,f,b,d,g,D){if("note"==a||"rest"==a)b=p.ax(b).toFixed(2),d=p.ay(d).toFixed(2),D=p.ah(D),ia[c]=[h,b,d,g,D];"bar"==a&&(d=p.ay(d),D=p.ah(D),d=Math.round(d+D),e[d]=1,q=p.ax(b),l=p.ax(0))},get_abcmodel:null});p.tosvg("abc2svg",a);""==c&&(c="no error");console.log(c.trim());if(g){G.innerHTML=g;L=Array.prototype.slice.call(G.getElementsByTagName("svg"));var v=Array.prototype.slice.call(G.getElementsByClassName("g"));T=v.length?v:L;N();L.forEach(function(a){xa(a,"click",f)});d&&z()}}}
function N(){if(0!=L.length){var a=L[0];var b=a.getBoundingClientRect().width;try{var d=a.viewBox.baseVal.width}catch(E){d=b}var C=(C=T[0].transform)?C.baseVal:[];C=C.length?C.getItem(0).matrix.a:1;da=d/C/b}}function r(a){function b(a,e){d=a.getBoundingClientRect();c=e.getBoundingClientRect();if(d.top<c.top||0>d.top||d.bottom>c.bottom||d.bottom>n)e.scrollTop=e==p?d.top-c.top:e.scrollTop+(d.top-c.top)}var f,d,k,c;var h=ba[a.vce];if(f=a.xy){var e=f[0];var l=f[1];var D=f[2];var F=f[3];f=f[4];a.inv&&
(f=F=0);if(e!=S[a.vce]){(k=h.parentNode)&&k.removeChild(h);k=T[e];k.insertBefore(h,k.firstChild);S[a.vce]=e;a=T[e];var p=document.scrollingElement;var n=document.documentElement.clientHeight;G.scrollHeight>G.clientHeight&&b(a,G);b(a,p)}h.setAttribute("x",l);h.setAttribute("y",D);h.setAttribute("width",F);h.setAttribute("height",f)}else h.setAttribute("width",0),h.setAttribute("height",0)}function z(){var a=0<u?w[u].t:0;w=[];ja={};var b=1,d=0,k=0,p=0,c=0,h=0,e;for(e=0;e<K.length;++e){var l=K[e];if(l.bt&&
0==l.v){if(l.t in ja&&":"==l.bt[0])continue;if(1==b&&":"==l.bt[0]&&l.t>p){e=k-1;b=2;d+=l.t-p;continue}2==b&&":"==l.bt[0]&&l.t>p&&(b=1);1==b&&":"==l.bt[l.bt.length-1]&&(k=e,p=l.t);c&&(l.tx||"|"!=l.bt)&&(c=0,d-=l.t-h);2==b&&"1"==l.tx&&(c=1,h=l.t)}c||(l.bt?ja[l.t]=1:w.push({t:l.t+d,xy:ia[l.ix],ns:l.ns,vce:l.v,inv:l.inv,tmp:l.tmp}))}for(u=0;u<w.length&&(l=w[u],!(l.t>=a)||l.inv);++u);u==w.length&&--u;r(w[u])}function A(){if(p){for(var a=1E3*p.currentTime,b=0,d;0==b;){var k=w[u];d=156.25/k.tmp;u==w.length-
1?(u=-1,b=k.ns[0].dur+1E3):(b=w[u+1].t,b=(b-k.t)*d);k.ns.forEach(function(c,b){d=192>=c.dur?1.3*d:1.1*d;b=c.mnum;var e=c.dur*d,f=k.vce;c=c.velo;if(-1!=b){var h=b>>7;if(h in ka&&v.withRT){var g=b%128,q=a/1E3;b=(e-1)/1E3;if(e=la[h][g]){var n=p.createBufferSource(),r=e.useflt,C=e.uselfo,E=e.useenv,x=H[f]/127;f=(I[f]-64)/64;n.buffer=e.buffer;e.loopStart&&(n.loop=!0,n.loopStart=e.loopStart,n.loopEnd=e.loopEnd);n.playbackRate.value=ma[h][g];if(C){var w=p.createOscillator();w.frequency.value=e.lfofreq;h=
p.createGain();h.gain.value=e.lfo2vol;w.connect(h);var u=p.createGain();u.gain.value=1;h.connect(u.gain);h=p.createGain();h.gain.value=e.lfo2ptc;w.connect(h);h.connect(n.detune)}if(r){var m=p.createBiquadFilter();m.type="lowpass";m.frequency.value=e.filter}if(E){var y=1;h=p.createGain();h.gain.setValueAtTime(0,q);h.gain.linearRampToValueAtTime(y,q+e.envatt);g=e.envhld;var t=e.envdec;if(b>g){h.gain.setValueAtTime(y,q+g);if(b<t){var z=b-g;t=z/(t-g)*e.envsus}else z=t-g,t=e.envsus;y*=t;h.gain.linearRampToValueAtTime(y,
q+g+z)}h.gain.setValueAtTime(y,q+b);g=q+b+y*e.envrel;h.gain.linearRampToValueAtTime(0,g);var A=p.createConstantSource();A.offset.value=e.env2flt;A.connect(h);h.connect(m.detune)}if(O){var B=p.createStereoPanner();B.pan.value=f}y=c*x*e.atten*ya;0==y&&(y=1E-5);c=p.createGain();c.gain.setValueAtTime(1E-5,q);c.gain.exponentialRampToValueAtTime(y,q+e.attack);g=e.hold;t=e.decay;b>g&&(c.gain.setValueAtTime(y,q+g),b<t?(z=b-g,t=Math.pow(10,z/(t-g)*Math.log10(e.sustain))):(z=t-g,t=e.sustain),y*=t,c.gain.exponentialRampToValueAtTime(y,
q+g+z));c.gain.setValueAtTime(y,q+b);g=q+b+(100+20*Math.log10(y))/100*e.release;c.gain.exponentialRampToValueAtTime(1E-5,g);r?(n.connect(m),m.connect(B||c)):n.connect(B||c);B&&B.connect(c);C?(c.connect(u),u.connect(p.destination)):c.connect(p.destination);n.start(q);C&&w.start(q+e.lfodel);E&&A.start(q);n.stop(g);C&&w.stop(g);E&&A.stop(g)}}else h in U&&0!=Z&&(u=a/1E3,w=(e-1)/1E3,B=H[f]/127,m=(I[f]-64)/64,A=p.createBufferSource(),A.buffer=ua[b],b=p.createGain(),b.gain.setValueAtTime(1E-5,u),c=c*B*.015625,
0==c&&(c=1E-5),b.gain.exponentialRampToValueAtTime(c,u+.001),O&&(q=p.createStereoPanner(),q.pan.value=m),A.connect(q||b),q&&q.connect(b),b.connect(p.destination),A.start(u),u+=w,b.gain.setValueAtTime(c,u),b.gain.exponentialRampToValueAtTime(1E-5,u+.1),A.stop(u+.1))}});r(k);u+=1}var n=a-na;na+=b;clearTimeout(oa);oa=setTimeout(A,n<b?b-n:b)}else alert("Your browser has no Web Audio API -> no playback.")}function M(a){switch(a.key){case "t":x.style.display="none"==x.style.display?"block":"none"}}function J(a){w.length&&
((ea=a)?(na=1E3*p.currentTime,A()):clearTimeout(oa))}function ra(a){return new Promise(function(b,d){for(var f=atob(a),g=new ArrayBuffer(f.length),c=new Uint8Array(g),h=0;h<f.length;h++)c[h]=f.charCodeAt(h);p.decodeAudioData(g,function(a){b(a)},function(a){d("error dedoding audio sample")})})}function wa(a){return new Promise(function(b,d){function f(g){var c=instData[g];if(!c&&g<instData.length-1)f(g+1);else{var h={attack:c.attack,hold:c.hold,decay:c.decay,sustain:c.sustain,release:c.release,atten:c.atten,
filter:c.filter,lfodel:c.lfodel,lfofreq:c.lfofreq,lfo2ptc:c.lfo2ptc,lfo2vol:c.lfo2vol,envatt:c.envatt,envhld:c.envhld,envdec:c.envdec,envsus:c.envsus,envrel:c.envrel,env2flt:c.env2flt,uselfo:V&&.008<c.lfofreq&&(0!=c.lfo2ptc||0!=c.lfo2vol),useflt:W&&16E3>c.filter,useenv:X&&16E3>c.filter&&0!=c.env2flt};c.loopStart&&(h.loopStart=c.loopStart,h.loopEnd=c.loopEnd);var e=c.scale;var l=c.tune;for(var k=c.keyRangeLo;k<=c.keyRangeHi;k++)ma[a][k]=Math.pow(Math.pow(2,1/12),(k+l)*e),la[a][k]=h;ra(c.sample).then(function(a){h.buffer=
a;g<instData.length-1?f(g+1):(instData="",b("ok"))}).catch(function(a){d(a)})}}ma[a]=[];la[a]=[];f(0)})}function pa(a,b){return new Promise(function(d,f){var g=document.createElement("script");g.src=b;g.onload=function(){d("ok");document.head.removeChild(g)};g.onerror=function(c){f("could not load instrument "+a)};document.head.appendChild(g)})}function qa(){function d(c,f,e,g){var h=f[c];c==f.length?g():h in ka?d(c+1,f,v.sf2url1,g):(b(c+" loading instrument: "+h+(e?" from: "+e:"")),pa(h,e+"instr"+
h+"mp3.js").then(function(){return wa(h)}).then(function(){ka[h]=1;d(c+1,f,v.sf2url1,g)}).catch(function(b){a(b);e==v.sf2url1&&v.sf2url2?d(c,f,v.sf2url2,g):(a(" ... switch to MIDI-js"),v.withRT=0,qa())}))}function k(c,d,e,f){var g=d[c],h=g in v.instTab?v.instTab[g]:za[g];if(c==d.length)f();else if(U[g])k(c+1,d,v.midijsUrl1,f);else{var l=e+h+"-mp3.js";b(c+" loading instrument: "+g+" from: "+l+"...");pa(g,l).then(function(){U[g]=MIDI.Soundfont[h];k(c+1,d,v.midijsUrl1,f)}).catch(function(b){a(b);e==
v.midijsUrl1?k(c,d,v.midijsUrl2,f):a(" ... give up")})}}function g(a,b){if(a==b.length)Z=1,x.style.display="none",console.log("notes decoded"),J(1);else{var c=b[a],d=c>>7,f=c%128,h=U[d]["C Db D Eb E F Gb G Ab A Bb B".split(" ")[f%12]+(Math.floor(f/12)-1)].split(",")[1];ra(h).then(function(e){ua[c]=e;x.innerHTML+=", "+d+":"+f;va[c]=1;g(a+1,b)})}}var n={};ca.forEach(function(a){n[a>>7]=1});x.innerHTML=v.withRT?"Loading SF2 fonts<br>":"Loading MIDI-js fonts<br>";x.style.display="block";x.style.top=document.scrollingElement.scrollTop+
document.documentElement.clientHeight/2.5+"px";if(v.withRT)d(0,Object.keys(n),v.sf2url1,function(){x.style.display="none";console.log("fonts geladen");J(1)});else{var p=ca.filter(function(a){return!(a in va)});k(0,Object.keys(n),v.midijsUrl1,function(){console.log("fonts geladen");x.innerHTML+="decode notes:";g(0,p)})}}function Y(){var a,b;if(a=document.getElementById("parms"))a.style.display="none";a=a?JSON.parse(a.innerText):{};for(d in a)v[d]=a[d];a=window.location.href.split("?");if(1<a.length)for(a=
a[1].split("&"),b=0;b<a.length;b++){var d=a[b];if("noRT"==d)v.withRT=0;else if("ios"==d)O=X=W=V=0;else if("keyt"==d)v.keyt=1;else if(d=d.match(/sf2=(\w+)/))v.sf2url2=d[1]+"/"}}function xa(a,b,d){function f(b){a.removeEventListener("mousedown",f);a.removeEventListener("touchend",f);console.log("event listeners removed from "+a.nodeName);p&&"suspended"==p.state&&p.resume().then(function(){console.log("resuming audioContext")})}a.addEventListener("mousedown",f);a.addEventListener("touchend",f);a.addEventListener(b,
d)}var v={withRT:1,sf2url1:"./",sf2url2:"",instTab:{},midijsUrl1:"./",midijsUrl2:"https://cdn.jsdelivr.net/gh/gleitz/midi-js-soundfonts@gh-pages/FluidR3_GM/"},K,aa,ta,u=0,ea=0,oa,Z=0,w=[],Q=[],ja={},ia={},fa=[],L=[],T=[],da,ha=0,S=[],ba=[],p=null,ua=[],va={},ca=[],ka={},U=[],sa={},H=[],I=[],G=null,x=null,za="acoustic_grand_piano bright_acoustic_piano electric_grand_piano honkytonk_piano electric_piano_1 electric_piano_2 harpsichord clavinet celesta glockenspiel music_box vibraphone marimba xylophone tubular_bells dulcimer drawbar_organ percussive_organ rock_organ church_organ reed_organ accordion harmonica tango_accordion acoustic_guitar_nylon acoustic_guitar_steel electric_guitar_jazz electric_guitar_clean electric_guitar_muted overdriven_guitar distortion_guitar guitar_harmonics acoustic_bass electric_bass_finger electric_bass_pick fretless_bass slap_bass_1 slap_bass_2 synth_bass_1 synth_bass_2 violin viola cello contrabass tremolo_strings pizzicato_strings orchestral_harp timpani string_ensemble_1 string_ensemble_2 synth_strings_1 synth_strings_2 choir_aahs voice_oohs synth_choir orchestra_hit trumpet trombone tuba muted_trumpet french_horn brass_section synth_brass_1 synth_brass_2 soprano_sax alto_sax tenor_sax baritone_sax oboe english_horn bassoon clarinet piccolo flute recorder pan_flute blown_bottle shakuhachi whistle ocarina lead_1_square lead_2_sawtooth lead_3_calliope lead_4_chiff lead_5_charang lead_6_voice lead_7_fifths lead_8_bass__lead pad_1_new_age pad_2_warm pad_3_polysynth pad_4_choir pad_5_bowed pad_6_metallic pad_7_halo pad_8_sweep fx_1_rain fx_2_soundtrack fx_3_crystal fx_4_atmosphere fx_5_brightness fx_6_goblins fx_7_echoes fx_8_scifi sitar banjo shamisen koto kalimba bagpipe fiddle shanai tinkle_bell agogo steel_drums woodblock taiko_drum melodic_tom synth_drum reverse_cymbal guitar_fret_noise breath_noise seashore bird_tweet telephone_ring helicopter applause gunshot".split(" "),
R=120,la=[],ma=[],ya=.5/60,O=1,V=1,W=1,X=1,na;document.addEventListener("DOMContentLoaded",function(){Array.prototype.slice.call(document.getElementsByClassName("abc")).forEach(function(a,b){var d=a.innerHTML.replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&");n("%%fullsvg _"+b+"\n"+d,a,0)});document.body.addEventListener("click",function(){ea&&J(0)},!1);window.addEventListener("resize",N,!1);x=document.getElementById("comp");Y();var a=window.AudioContext||window.webkitAudioContext;p=
void 0!=a?new a:null;a=["Your browser does not support:"];var b=0;p?(p.createStereoPanner||(O=0),p.createOscillator||(V=0),p.createBiquadFilter||(W=0),p.createConstantSource||(X=0),O||a.push("* the StereoPanner element"),v.withRT&&!V&&(a.push("* the Oscillator element"),b=1),v.withRT&&!W&&(a.push("* the BiquadFilter element"),b=1),v.withRT&&!X&&(a.push("* the ConstantSource element"),b=1),b&&(a.push("You are probably on iOS, which does not support the Web Audio API."),a.push("Real time synthesis is switched off, falling back to MIDIjs"),
v.withRT=0)):a.push("* the Web Audio API -> no sound");1<a.length&&alert(a.join("\n"));v.keyt&&document.body.addEventListener("keydown",M)})})();
